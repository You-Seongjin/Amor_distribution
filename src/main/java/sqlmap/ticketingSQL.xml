<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.amor.ticketingSQL">

<select id="ticketingHistoryList" parameterType="Integer" resultType="com.amor.ticketing.model.JoinTicketingHistoryDTO">
  <![CDATA[
select rownum as rnum,c.movie_name as moviename,c.movie_poster as movieimg,b.ticketing_num as ticketnum,
b.theater_name as theatername,b.ticketing_seat as seatnum,b.ticketing_screeningtime as screeningdate,
b.ticketing_payment as payment,b.ticketing_price as price,b.ticketing_reservetime as reservetime,
to_char(case 
    when to_number((to_date(b.ticketing_screeningtime, 'YYYY-MM-DD HH24:MI:SS') - to_date(sysdate, 'YYYY-MM-DD HH24:MI:SS')) * 24 * 60) >= 30 
    then 'y'
    when to_number((to_date(b.ticketing_screeningtime, 'YYYY-MM-DD HH24:MI:SS') - to_date(sysdate, 'YYYY-MM-DD HH24:MI:SS')) * 24 * 60) < 30
    then 'n'
    else 'null'
end)as timelimit
from playing_movie a,(select * from ticketing,theater
where ticketing.member_idx = #{useridx} and ticketing.ticketing_state = 'y' 
and ticketing.theater_idx = theater.theater_idx
order by ticketing_reservetime desc) b , movie c
where a.playing_movie_idx = b.playing_movie_idx and a.movie_idx = c.movie_idx
]]>
</select>


<select id = "ticketingcancellList" parameterType="Integer" resultType="com.amor.ticketing.model.JoinTicketingHistoryDTO">
<![CDATA[
select c.movie_name as moviename,c.movie_poster as movieimg,b.ticketing_num as ticketnum,
b.theater_name as theatername,b.ticketing_seat as seatnum,b.ticketing_screeningtime as screeningdate,
b.ticketing_payment as payment,b.ticketing_price as price,b.ticketing_reservetime as reservetime 
from playing_movie a,(select * from ticketing,theater
where member_idx = #{useridx} and ticketing_state = 'n'
and ticketing.theater_idx = theater.theater_idx) b , movie c
where a.playing_movie_idx = b.playing_movie_idx and a.movie_idx = c.movie_idx
]]>
</select>

<update id="cancellationTicket" parameterType="String">
update ticketing
set ticketing_state = 'n'
where ticketing_num = #{ticketnum}
</update>
</mapper>