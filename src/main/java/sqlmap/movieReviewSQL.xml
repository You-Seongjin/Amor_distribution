<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.amor.movieReviewSQL">
	<select id="reviewList" parameterType="Map" resultType="com.amor.movieReview.model.MovieReviewJoinDTO">
		select 
			f.movie_name, 
			c.movie_review_content, 
			c.movie_review_img, 
			d.member_idx, 
			e.ticketing_screeningtime 
		from 
			(select * from (select rownum as rnum,a.* from 
			(select * from movie_review order by movie_review_idx desc)a)b 
			where rnum<![CDATA[>=]]>#{start} and rnum<![CDATA[<=]]>#{end}) c,
			 member d, 
			 ticketing e, 
			 movie f 
		 where 
		 	d.member_idx=c.member_idx 
			 and c.member_idx=e.member_idx
			 and f.movie_idx=c.movie_idx 
			 and d.member_idx=#{member_idx}
	</select>
	<select id="totalCntReview" resultType="Integer">
		select count(*) from movie_review
	</select>
	
	<select id="reviewListTotalCnt" resultType="Integer">
		select count(*) from movie_review
	</select>
	
	<select id="adminReviewList" parameterType="Map" resultType="com.amor.movieReview.model.MovieReviewDTO">
		select * from
		(select rownum as rnum, a.* from
		(select mr.movie_review_idx,
		(select member_id from member mm where mm.member_idx=mr.member_idx) as member_id, 
		(select movie_name from movie mv where mv.movie_idx=mr.movie_idx) as movie_name,
		mr.movie_review_content,mr.movie_review_writedate,
		(select member_block from member mm where mm.member_idx=mr.member_idx) as member_block 
		from movie_review mr order by movie_review_idx desc) a)
		where rnum <![CDATA[>=]]> #{start} and rnum <![CDATA[<=]]> #{end}
	</select>
	
	<select id="adminReviewPopup" parameterType="Integer" resultType="com.amor.movieReview.model.MovieReviewDTO">
		select 
		(select member_id from member mm where mm.member_idx=mr.member_idx) as member_id,
		mr.*
		from movie_review mr
		where mr.movie_review_idx=#{idx}
	</select>
	
	<update id="blockUpdate" parameterType="Map">
		update member
		set member_block=#{value}
		where member_idx=
		(select mr.member_idx from movie_review mr where mr.movie_review_idx=#{idx})
	</update>
</mapper>